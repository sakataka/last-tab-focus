<!DOCTYPE html>
<html>
<head>
    <title>Multi-Window Test - Last Tab Focus</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: linear-gradient(45deg, #f0f8ff, #e6f3ff); }
        .window-info { padding: 15px; background: white; border-radius: 8px; margin: 10px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .test-section { margin: 15px 0; padding: 15px; border: 2px solid #007bff; border-radius: 8px; background: white; }
        button { margin: 5px; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; }
        .primary { background: #007bff; color: white; }
        .secondary { background: #6c757d; color: white; }
        .success { background: #28a745; color: white; }
        .danger { background: #dc3545; color: white; }
        .log { font-family: monospace; background: #f8f9fa; padding: 10px; border-radius: 4px; white-space: pre-wrap; max-height: 200px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>ðŸªŸ Multi-Window Test Page</h1>
    
    <div class="window-info">
        <h3>Current Window Info</h3>
        <p><strong>Window ID:</strong> <span id="windowId">Loading...</span></p>
        <p><strong>Tab ID:</strong> <span id="tabId">Loading...</span></p>
        <p><strong>Opened at:</strong> <span id="timestamp"></span></p>
    </div>
    
    <div class="test-section">
        <h3>ðŸ”¥ Window Management</h3>
        <button class="primary" onclick="openNewWindow()">Open New Window</button>
        <button class="secondary" onclick="focusThisWindow()">Focus This Window</button>
        <button class="danger" onclick="closeThisWindow()">Close This Window</button>
    </div>
    
    <div class="test-section">
        <h3>ðŸ“‘ Tab Management</h3>
        <button class="primary" onclick="openTabInThisWindow('Page A')">Open Tab A (This Window)</button>
        <button class="primary" onclick="openTabInThisWindow('Page B')">Open Tab B (This Window)</button>
        <button class="primary" onclick="openTabInThisWindow('Page C')">Open Tab C (This Window)</button>
        <button class="secondary" onclick="switchToTab()">Random Tab Switch</button>
        <button class="danger" onclick="closeRandomTab()">Close Random Tab</button>
    </div>
    
    <div class="test-section">
        <h3>ðŸ§ª Test Scenarios</h3>
        <button class="success" onclick="runBasicTest()">Run Basic Test</button>
        <button class="success" onclick="runWindowSwitchTest()">Run Window Switch Test</button>
        <button class="success" onclick="runStressTest()">Run Stress Test</button>
    </div>
    
    <div class="test-section">
        <h3>ðŸ“Š Test Log</h3>
        <button onclick="clearLog()">Clear Log</button>
        <div id="testLog" class="log">Test log will appear here...\n</div>
    </div>
    
    <div class="test-section">
        <h3>âœ… Test Checklist</h3>
        <ul>
            <li>Multiple windows can be opened independently</li>
            <li>Tab focus history is maintained per window</li>
            <li>Closing a tab in one window doesn't affect other windows</li>
            <li>Window closure cleans up its tabs from global history</li>
            <li>Extension works efficiently with many windows and tabs</li>
        </ul>
    </div>

    <script>
        let testLog = document.getElementById('testLog');
        let tabCounter = 1;
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            testLog.textContent += `[${timestamp}] ${message}\n`;
            testLog.scrollTop = testLog.scrollHeight;
        }
        
        function clearLog() {
            testLog.textContent = 'Test log cleared...\n';
        }
        
        function openNewWindow() {
            const url = window.location.href;
            const newWindow = window.open(url, '_blank', 'width=800,height=600');
            log(`Opened new window`);
        }
        
        function focusThisWindow() {
            window.focus();
            log('Focused this window');
        }
        
        function closeThisWindow() {
            log('Closing this window...');
            window.close();
        }
        
        function openTabInThisWindow(name) {
            const uniqueName = `${name} #${tabCounter++}`;
            const url = `data:text/html,<html><head><title>${uniqueName}</title></head><body style="font-family:Arial;padding:20px;background:linear-gradient(45deg,#ff6b6b,#ffd93d);"><h1>${uniqueName}</h1><p>Created at: ${new Date().toLocaleString()}</p><button onclick="window.close()">Close This Tab</button></body></html>`;
            window.open(url, '_blank');
            log(`Opened tab: ${uniqueName}`);
        }
        
        function switchToTab() {
            // This is just for logging; actual tab switching happens via user action
            log('Please manually switch between tabs to test focus history');
        }
        
        function closeRandomTab() {
            log('Please manually close a tab to test focus switching');
        }
        
        function runBasicTest() {
            log('=== BASIC TEST STARTED ===');
            log('1. Opening 3 tabs in this window...');
            openTabInThisWindow('Test Tab 1');
            setTimeout(() => openTabInThisWindow('Test Tab 2'), 500);
            setTimeout(() => openTabInThisWindow('Test Tab 3'), 1000);
            setTimeout(() => {
                log('2. Please switch between the tabs, then close the active tab');
                log('3. Verify that focus moves to the previously active tab');
                log('=== BASIC TEST SETUP COMPLETE ===');
            }, 1500);
        }
        
        function runWindowSwitchTest() {
            log('=== WINDOW SWITCH TEST STARTED ===');
            log('1. Opening new window...');
            openNewWindow();
            setTimeout(() => {
                log('2. In the new window, open several tabs');
                log('3. Switch between windows and tabs');
                log('4. Close tabs in different windows');
                log('5. Verify that each window maintains its own tab history');
                log('=== WINDOW SWITCH TEST SETUP COMPLETE ===');
            }, 1000);
        }
        
        function runStressTest() {
            log('=== STRESS TEST STARTED ===');
            log('Opening multiple tabs rapidly...');
            for (let i = 1; i <= 5; i++) {
                setTimeout(() => {
                    openTabInThisWindow(`Stress Test Tab ${i}`);
                }, i * 200);
            }
            setTimeout(() => {
                log('Multiple tabs opened. Please:');
                log('1. Rapidly switch between tabs');
                log('2. Close tabs in various orders');
                log('3. Check browser console for any errors');
                log('4. Monitor memory usage');
                log('=== STRESS TEST SETUP COMPLETE ===');
            }, 2000);
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('timestamp').textContent = new Date().toLocaleString();
            document.getElementById('windowId').textContent = 'Unknown (check console)';
            document.getElementById('tabId').textContent = 'Unknown (check console)';
            
            log('Multi-window test page loaded');
            log('Ready for testing!');
        });
        
        // Log window focus events
        window.addEventListener('focus', () => log('Window gained focus'));
        window.addEventListener('blur', () => log('Window lost focus'));
    </script>
</body>
</html>